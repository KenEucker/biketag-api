!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n=e();for(var i in n)("object"==typeof exports?exports:t)[i]=n[i]}}(global,(function(){return(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{BikeTagClient:()=>Se,default:()=>qe});var n={};t.r(n),t.d(n,{getAlbumIdFromTextRegex:()=>q,getCreditFromTextRegex:()=>_,getDiscussionUrlFromTextRegex:()=>L,getFoundLocationFromTextRegex:()=>F,getGPSCoordinatesValueFromTextRegex:()=>M,getGPSLocationFromTextRegex:()=>D,getHintFromTextRegex:()=>R,getImageURLsFromTextRegex:()=>S,getImgurImageHashFromUrlRegex:()=>B,getTagNumbersFromTextRegex:()=>j,getTagnumberFromSlugRegex:()=>N});var i={};t.r(i),t.d(i,{getBikeTagDescriptionFromData:()=>ht,getBikeTagProofDescriptionFromData:()=>vt,getBikeTagProofTitleFromData:()=>pt,getBikeTagTitleFromData:()=>mt,getCreditFromText:()=>tt,getDiscussionUrlFromText:()=>st,getFoundLocationFromText:()=>et,getGPSLocationFromText:()=>it,getHintFromText:()=>nt,getImageHashFromText:()=>at,getImageURLsFromText:()=>ot,getImgurAlbumIdFromText:()=>rt,getImgurFoundDescriptionFromBikeTagData:()=>lt,getImgurFoundImageHashFromBikeTagData:()=>ut,getImgurFoundTitleFromBikeTagData:()=>ct,getImgurMysteryDescriptionFromBikeTagData:()=>ft,getImgurMysteryImageHashFromBikeTagData:()=>dt,getImgurMysteryTitleFromBikeTagData:()=>gt,getTagNumbersFromText:()=>Z,getTagnumberFromSlug:()=>Y});var r={};t.r(r),t.d(r,{deleteTag:()=>yt,getGameData:()=>Tt,getTag:()=>$t,getTags:()=>kt,updateTag:()=>Ot,uploadTagImage:()=>At});var o={};t.r(o),t.d(o,{deleteTag:()=>Dt,getTag:()=>St,getTags:()=>Lt,updateTag:()=>Ht,uploadTagImage:()=>Vt});var s={};t.r(s),t.d(s,{deleteTag:()=>zt,favoriteImage:()=>Zt,getTag:()=>Jt,queueTagImage:()=>Yt,updateTag:()=>Qt,updateTagImage:()=>Xt});var a={};t.r(a),t.d(a,{deleteTag:()=>te,getTag:()=>oe,getTags:()=>ae,updateTag:()=>ue,uploadTagImage:()=>le});var u={};t.r(u),t.d(u,{deleteTag:()=>ye,getTag:()=>be,getTags:()=>xe,updateTag:()=>ke,uploadTagImage:()=>Ue});const l=require("axios");var c=t.n(l);const d=require("events"),g="https://api.biketag.org";var f;!function(t){t[t.biketag=0]="biketag",t[t.imgur=1]="imgur",t[t.sanity=2]="sanity",t[t.reddit=3]="reddit",t[t.twitter=4]="twitter"}(f||(f={})),require("form-data");const h=(t,e,n)=>{n&&n.put(t,e)},m=(t,e)=>e?e.get(t):null,v=(t,e="")=>`${e}-tag-${t}`,p=t=>void 0!==(null==t?void 0:t.clientId)||void 0!==(null==t?void 0:t.clientSecret)||void 0!==(null==t?void 0:t.clientId)&&void 0!==(null==t?void 0:t.hash),y=t=>void 0!==(null==t?void 0:t.clientId)||void 0!==(null==t?void 0:t.username)&&void 0!==t.password,b=t=>void 0!==(null==t?void 0:t.projectId),w=t=>{var e,n,i;return void 0!==(null===(e=t)||void 0===e?void 0:e.game)||void 0!==(null===(n=t)||void 0===n?void 0:n.clientToken)&&void 0!==(null===(i=t)||void 0===i?void 0:i.clientKey)},x=(t,e={})=>{var n,i,r,o;return{clientId:null!==(n=t.clientId)&&void 0!==n?n:e.clientId,clientSecret:null!==(i=t.clientSecret)&&void 0!==i?i:e.clientSecret,account:null!==(r=t.account)&&void 0!==r?r:e.account,accessToken:null!==(o=t.accessToken)&&void 0!==o?o:e.accessToken}},I=(t,e={})=>{var n,i,r,o;return{hash:null!==(n=t.hash)&&void 0!==n?n:e.hash,clientId:(null===(i=t.clientId)||void 0===i?void 0:i.length)?t.clientId:e.clientId,clientSecret:(null===(r=t.clientSecret)||void 0===r?void 0:r.length)?t.clientSecret:e.clientSecret,accessToken:(null===(o=t.accessToken)||void 0===o?void 0:o.length)?t.accessToken:e.accessToken}},T=t=>p(t)?I(t):void 0,$=(t,e={})=>{var n,i,r,o,s,a,u,l,c,d,g,f;return{useCdn:!(null===(n=t.token)||void 0===n?void 0:n.length)&&(null===(r=null!==(i=t.useCdn)&&void 0!==i?i:e.useCdn)||void 0===r||r),projectId:null!==(o=t.projectId)&&void 0!==o?o:e.projectId,dataset:null!==(a=null!==(s=t.dataset)&&void 0!==s?s:e.dataset)&&void 0!==a?a:"development",token:(null===(u=t.token)||void 0===u?void 0:u.length)?t.token:null!==(l=e.token)&&void 0!==l?l:"",password:(null===(c=t.password)||void 0===c?void 0:c.length)?t.password:e.password,username:(null===(d=t.username)||void 0===d?void 0:d.length)?t.username:e.username,apiVersion:(null===(g=t.apiVersion)||void 0===g?void 0:g.length)?t.apiVersion:null!==(f=e.apiVersion)&&void 0!==f?f:"2021-06-07"}},k=t=>b(t)?$(t):void 0,O=(t,e={})=>{var n,i,r,o,s,a,u,l;return{subreddit:null!==(n=t.subreddit)&&void 0!==n?n:e.subreddit,clientId:null!==(i=t.clientId)&&void 0!==i?i:e.clientId,clientSecret:(null===(r=t.clientSecret)||void 0===r?void 0:r.length)?t.clientSecret:e.clientSecret,password:(null===(o=t.password)||void 0===o?void 0:o.length)?t.password:e.password,username:(null===(s=t.username)||void 0===s?void 0:s.length)?t.username:e.username,refreshToken:(null===(a=t.refreshToken)||void 0===a?void 0:a.length)?t.refreshToken:e.refreshToken,userAgent:(null===(u=t.userAgent)||void 0===u?void 0:u.length)?t.userAgent:null!==(l=e.userAgent)&&void 0!==l?l:De}},A=t=>y(t)?O(t):void 0,P=(t,e={})=>{var n,i,r,o,s;return{game:null!==(n=t.game)&&void 0!==n?n:e.game,source:null!==(i=t.source)&&void 0!==i?i:e.source,clientKey:(null===(r=t.clientKey)||void 0===r?void 0:r.length)?t.clientKey:e.clientKey,clientToken:(null===(o=t.clientToken)||void 0===o?void 0:o.length)?t.clientToken:e.clientToken,accessToken:(null===(s=t.accessToken)||void 0===s?void 0:s.length)?t.accessToken:e.accessToken}},U=require("axios-cache-adapter"),C=require("lodash");var E=t.n(C);const j=new RegExp(/((?:(?:bike\s*)?(?:\s*tag)?)#(\d+)(?:(?:\s*tag)?|(?:\s*proof)?))|((?:bike\s*)?(?:tag\s*)#?\s*(\d+))|((?:(?:found\s*#?)|(?:here'?i?s?\s*))\[?(\d+)\]?)/gi),_=new RegExp(/((?:proof\s*(?:found\s*at\s*)?(?:\(.*\))?\s*by\s*)(.*?(?=])))|((?:tag\s*(?:\((?:hint:)?.*\))?\s*by\s*)(.+?(?=]|\r|\n|$))?)|((?:tag\s*(?:\((?:hint:)?.*\))?\s*by\s*)(.+?(?=]|\r|\n))?)|((?:credit goes to:\s*)(.*)(?:\sfor finding))/gi),F=new RegExp(/(?:found at \()(.+?)(?:\))|(?:\[(?:\s*bike\s*)(?:\s*tag\s*))#?(\d+)(?:(?:\])|(?:\s*.\s*(.*)\]))/gi),R=new RegExp(/(?:hint:\s*?)([^)]*)/gi),D=new RegExp(/(([0-9]{1,2})[:|°]([0-9]{1,2})[:|'|′]?([0-9]{1,2}(?:\.[0-9]+){0,1})?["|″]([N|S]),?\s*([0-9]{1,3})[:|°]([0-9]{1,2})[:|'|′]?([0-9]{1,2}(?:\.[0-9]+){0,1})?["|″]([E|W]))|((-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?))/g),S=new RegExp(/https?:\/\/.*?\.[a-z]{2,4}\/.+?(?=\)|\s)/gi),q=new RegExp(/((?:imgur.com\/)(?:(a|album|gallery)\/)(\w+))/gi),L=RegExp(/{(.*)}/gi),M=RegExp(/\((.*)\)/gi),N=RegExp(/([^-]*)([^-]*)(\d)/g),B=RegExp(/(?:imgur.com\/)(.*)(?:\.)/gi),H=(t={})=>{var e,n,i,r,o,s,a,u,l,c,d;return{tagnumber:null!==(e=t.tagnumber)&&void 0!==e?e:"latest",mysteryImage:t.mysteryImage,mysteryImageUrl:null!==(n=t.mysteryImageUrl)&&void 0!==n?n:"",game:null!==(i=t.game)&&void 0!==i?i:"",slug:null!==(r=t.slug)&&void 0!==r?r:"",name:null!==(o=t.name)&&void 0!==o?o:"",player:null!==(s=t.player)&&void 0!==s?s:"",hint:null!==(a=t.hint)&&void 0!==a?a:"",discussionUrl:null!==(u=t.discussionUrl)&&void 0!==u?u:"",foundLocation:null!==(l=t.foundLocation)&&void 0!==l?l:"",gps:null!==(c=t.gps)&&void 0!==c?c:"",foundImage:t.foundImage,foundImageUrl:null!==(d=t.foundImageUrl)&&void 0!==d?d:"",_id:t._id,_type:t._type}},K=Object.keys(H()),W=["game","player"],G=["foundImage","mysteryImage"],V={foundImage:"asset->_ref",mysteryImage:"asset->_ref"},z=(t={})=>{var e,n,i,r,o,s,a,u,l;return{name:null!==(e=t.name)&&void 0!==e?e:"",ambassadors:null!==(n=t.ambassadors)&&void 0!==n?n:[],boundary:null!==(i=t.boundary)&&void 0!==i?i:{},mainhash:null!==(r=t.mainhash)&&void 0!==r?r:"",queuehash:null!==(o=t.queuehash)&&void 0!==o?o:"",subreddit:null!==(s=t.subreddit)&&void 0!==s?s:"",logo:null!==(a=t.logo)&&void 0!==a?a:"",region:null!==(u=t.region)&&void 0!==u?u:"",slug:null!==(l=t.slug)&&void 0!==l?l:""}},J=["region"],Q=["ambassadors","tags"],X=Object.keys(z()),Y=(t,e,n)=>{if(!t.length)return e;const i=`slug::${t}`,r=m(i,n);if(r)return r;t.match(N);const o=N.exec(t);if(!o)return h(i,e,n),e;const s=parseInt((o[0]||"").trim());return h(i,s,n),s},Z=(t,e,n)=>{if(!t.length)return e;const i=`tag::${t}`,r=m(i,n);if(r)return r;const o=t.match(j);if(!o)return e||[];const s=o.reduce(((t,e)=>{const n=e.match(/\d+/),i=n&&n.length?n[0]:null;if(!i)return t;const r=Number.parseInt(i);return-1==t.indexOf(r)&&t.push(r),t}),[]);return!s.length&&e?(h(i,e,n),e):(h(i,s,n),s)},tt=(t,e,n)=>{if(!t.length)return e;const i=`credit::${t}`,r=m(i,n);if(r)return r;t.match(_);const o=_.exec(t);if(!o)return e||null;const s=o.filter((t=>!("string"!=typeof t||-1!==t.indexOf("tag ")&&0===t.indexOf("tag")||-1!==t.indexOf("proof ")&&0===t.indexOf("proof")||-1!==t.indexOf("to:")||-1!==t.indexOf("hint:")||-1!==t.indexOf("by")&&0===t.indexOf("by"))));if(!s.length&&e)return h(i,e,n),e;const a=s[0];return h(i,a,n),a},et=(t,e,n)=>{if(!t.length)return e;const i=`gps::${t}`,r=m(i,n);if(r)return r;t.match(F);const o=F.exec(t);if(!o)return h(i,e=e||null,n),e;const s=(o[1]||"").trim();return h(i,s,n),s},nt=(t,e,n)=>{if(!t.length)return e;const i=`hint::${t}`,r=m(i,n);if(r)return r;const o=t.match(R);if(!o)return e||null;const s=o.reduce(((t,e)=>{const n=e.match(/\d+/),i=n&&n.length?n[0]:null;if(!i)return t;const r=Number.parseInt(i);return-1==t.indexOf(r)&&t.push(r),t}),[]);return!s.length&&e?(h(i,e,n),e):(h(i,s,n),s)},it=(t,e,n)=>{if(!t.length)return e;const i=`gps::${t}`,r=m(i,n);if(r)return r;(t=t.replace(/\\/g,"")).match(D);const o=D.exec(t);if(!o)return h(i,e=e||null,n),e;if(o.length){const t=o[0].split(","),e={lat:parseFloat(t[0]),long:parseFloat(t[1]),alt:0};return h(i,e,n),e}return{}},rt=(t,e,n)=>{if(!t.length)return e;const i=`images::${t}`,r=m(i,n);if(r)return r;t.match(q);const o=q.exec(t).reduce(((t,e)=>(-1===e.indexOf("gallery")&&-1===e.indexOf("?")&&-1===e.indexOf("a/")&&e.length>1&&t.push(e),t)),[]);if(!o.length&&e)return h(i,e,n),e;const s=o[0];return h(i,s,n),s},ot=(t,e,n)=>{if(!t.length)return e;const i=`images::${t}`,r=m(i,n);if(r)return r;const o=["imgur"],s=t.match(S).reduce(((t,e)=>{if(!e||!new RegExp(o.join("|")).test(e))return t;const n=/[^.]+$/.test(e)?"."+/[^.]+$/.exec(e):"";return-1===[".jpg",".jpeg",".png",".bmp"].indexOf(n)&&0===n.indexOf(".com/")&&-1!==e.indexOf("//imgur.com/")&&-1===e.indexOf("3/album")&&-1===e.indexOf("/a/")&&-1===e.indexOf(".com/gallery")&&e.length>2&&(e=`${e.replace("//imgur.com","//i.imgur.com")}.jpg`),t.push(e),t}),[]);return!s.length&&e?(h(i,e,n),e):(h(i,s,n),s)},st=(t,e)=>{if(!t.length)return"";const n=`discussion::${t}`,i=m(n,e);if(i)return i;t.match(L);const r=L.exec(t);if(!r.length)return h(n,null,e),null;const o=(r[1]||"").trim();return h(n,o,e),o},at=(t,e)=>{if(!t.length)return"";const n=`hash::${t}`,i=m(n,e);if(i)return i;t.match(B);const r=B.exec(t);if(!r||!r.length)return h(n,null,e),null;const o=(r[1]||"").trim();return h(n,o,e),o},ut=(t,e)=>at(t.foundImageUrl,e),lt=(t,e)=>`#${t.tagnumber} proof${t.foundLocation?` found at (${t.foundLocation})`:""} by ${t.player}`,ct=(t,e)=>{var n,i,r;return!t.gps||0===t.gps.lat&&0===t.gps.long?"":`(${null!==(n=t.gps.lat)&&void 0!==n?n:0}, ${null!==(i=t.gps.long)&&void 0!==i?i:0}, ${null!==(r=t.gps.alt)&&void 0!==r?r:0})`},dt=(t,e)=>at(t.mysteryImageUrl,e),gt=(t,e)=>{var n,i,r;return`${!t.gps||0===t.gps.lat&&0===t.gps.long?"":`(${null!==(n=t.gps.lat)&&void 0!==n?n:0}, ${null!==(i=t.gps.long)&&void 0!==i?i:0}, ${null!==(r=t.gps.alt)&&void 0!==r?r:0})`} ${t.discussionUrl?`{${t.discussionUrl}}`:""}`},ft=(t,e)=>`#${t.tagnumber} tag (hint: ${t.hint?t.hint:""} ) by ${t.player}`,ht=t=>`#${t.currentTagNumber} tag ${t.hint?`(hint: ${t.hint})`:""} by ${t.credit}`,mt=t=>`${t.gps?`(${t.gps})`:""} {${t.discussionLink?t.discussionLink:""}}`,vt=t=>`#${t.proofTagNumber} proof${t.foundAt?` found at (${t.foundAt})`:""} by ${t.credit}`,pt=t=>`(${t.gps?t.gps:""})`;function yt(t,e){var n,i,r,o,s;return i=this,r=void 0,s=function*(){if(!(null===(n=e.slug)||void 0===n?void 0:n.length)){if(!e.tagnumber)return{data:null,success:!1,status:0,source:f[f.sanity]};e.slug=`${e.game}-tag-${e.tagnumber}`}const i=`*[_type == "tag" && _id == ${e.slug}]`;return t.delete({query:i}).then((t=>({data:t,success:!0,status:1,source:f[f.sanity]})))},new((o=void 0)||(o=Promise))((function(t,e){function n(t){try{u(s.next(t))}catch(t){e(t)}}function a(t){try{u(s.throw(t))}catch(t){e(t)}}function u(e){var i;e.done?t(e.value):(i=e.value,i instanceof o?i:new o((function(t){t(i)}))).then(n,a)}u((s=s.apply(i,r||[])).next())}))}function bt(t,e=[]){var n,i;const r=e.length?e.reduce(((e,n)=>(e[n]=t[n],e)),{}):t;return W.forEach((t=>{r[t]&&void 0!==r[t]&&(r[t]=r[t].name)})),Object.keys(V).forEach((t=>{if(r[t]&&void 0!==r[t]){const e=V[t].split("->");let n=r[t];e.forEach((t=>{var e;n=null!==(e=n[t])&&void 0!==e?e:void 0})),r[t]=n}})),r.slug=null!==(i=null===(n=r.slug)||void 0===n?void 0:n.current)&&void 0!==i?i:"latest",H(r)}function wt(t,e,n=[]){var i,r,o,s,a,u,l;return s=this,a=void 0,l=function*(){const s=n.length?n.reduce(((t,n)=>(t[n]=e[n],t)),{}):e;for(const e of W){const n=s[e];if(n){const i=`*[_type == "${e}" && slug.current == "${n}"]{_id}`,r=yield t.fetch(i,{});let o="";o=r.length?r[0]._id:(yield t.createIfNotExists({_id:(a=n,a.replace(/\s/g,"_").replace(/\//g,"-").replace(/[^\w\d]/g,"").toLowerCase()),_type:e,name:n}))._id,s[e]={_type:"reference",_ref:o}}}var a;for(const t of G){const e=s[t];e&&(s[t]={_type:"image",asset:{_type:"reference",_ref:e}})}return s._type="tag",s._id=null!==(i=s._id)&&void 0!==i?i:s.slug,s.slug={current:null!==(o=null===(r=s.slug)||void 0===r?void 0:r.current)&&void 0!==o?o:s.slug},H(s)},new((u=void 0)||(u=Promise))((function(t,e){function n(t){try{r(l.next(t))}catch(t){e(t)}}function i(t){try{r(l.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof u?r:new u((function(t){t(r)}))).then(n,i)}r((l=l.apply(s,a||[])).next())}))}function xt(t,e=[]){var n,i;const r=e.length?e.reduce(((e,n)=>(e[n]=t[n],e)),{}):t;return J.forEach((t=>{r[t]&&void 0!==r[t]&&(r[t]=r[t].name)})),r.slug=null!==(i=null===(n=r.slug)||void 0===n?void 0:n.current)&&void 0!==i?i:r.slug,z(r)}function It(t=[],e="tag"){let n=[],i=[];return"game"===e?(n=J,t=t.length?t:X,i=Q):(n=W,t=t.length?t:K),t.reduce(((t,e)=>{const r=-1!=n.indexOf(e);return t+`${-1!=i.indexOf(e)?`"${e}": ${e}[]->name`:r?`${e}->{name}`:e},`}),"").slice(0,-1)}function Tt(t,e){var n,i,r,o,s,a;return r=this,o=void 0,a=function*(){if(!e)throw new Error("no options");const r=It(e.fields,"game"),o=null===(n=e.slug)||void 0===n?void 0:n.length,s=null===(i=e.name)||void 0===i?void 0:i.length,a=o?`*[_type == "game" && slug.current == "${e.slug}"][0]{${r}}`:s?`*[_type == "game" && name match "${e.name}"][0]{${r}}`:'*[_type == "game"]';return t.fetch(a,{}).then((t=>{const n=Array.isArray(t),i=n?t:[t],r=[];for(const t of i)r.push(xt(t,e.fields));return{data:n?r:r[0],status:1,success:!0,source:f[f.sanity]}}))},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{u(a.next(t))}catch(t){e(t)}}function i(t){try{u(a.throw(t))}catch(t){e(t)}}function u(e){var r;e.done?t(e.value):(r=e.value,r instanceof s?r:new s((function(t){t(r)}))).then(n,i)}u((a=a.apply(r,o||[])).next())}))}function $t(t,e){var n,i,r,o,s,a;return r=this,o=void 0,a=function*(){if(!e)throw new Error("no options");if(!(null===(n=e.slug)||void 0===n?void 0:n.length)&&!e.tagnumber)throw new Error("no slug or tagnumber");let r="",o="";e.slug&&(r=`&& slug.current == "${e.slug}"`),e.tagnumber&&(o=`&& tagnumber == ${e.tagnumber}`);const s=(null===(i=e.fields)||void 0===i?void 0:i.length)?e.fields:K,a=It(s),u="latest"===e.slug,l="first"===e.slug,c=u?"|order(tagnumber desc)[0]":l?"|order(tagnumber asc)[0]":r.length?r:o,d=u||l?`*[_type == "tag"]{${a}}${c}`:`*[_type == "tag" ${c}][0]{${a}}`;return t.fetch(d,{}).then((t=>({data:bt(t,s),status:1,success:!0,source:f[f.sanity]})))},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{u(a.next(t))}catch(t){e(t)}}function i(t){try{u(a.throw(t))}catch(t){e(t)}}function u(e){var r;e.done?t(e.value):(r=e.value,r instanceof s?r:new s((function(t){t(r)}))).then(n,i)}u((a=a.apply(r,o||[])).next())}))}function kt(t,e){var n,i,r,o,s,a,u;return o=this,s=void 0,u=function*(){if(!e)throw new Error("no options");let o="",s="";(null===(n=e.slugs)||void 0===n?void 0:n.length)&&(o=`&& slug.current in ${JSON.stringify(e.slugs)}`),(null===(i=e.tagnumbers)||void 0===i?void 0:i.length)&&(s=`&& tagnumber in ${JSON.stringify(e.tagnumbers)}`);const a=(null===(r=e.fields)||void 0===r?void 0:r.length)?e.fields:K,u=It(a),l=`*[_type == "tag" && game._ref in *[_type=="game" && lower(name)=="${e.game.toLowerCase()}"]._id ${o} ${s}]{${u}}`;return t.fetch(l,{}).then((t=>({data:t.map((t=>bt(t,a))),status:1,success:!0,source:f[f.sanity]})))},new((a=void 0)||(a=Promise))((function(t,e){function n(t){try{r(u.next(t))}catch(t){e(t)}}function i(t){try{r(u.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof a?r:new a((function(t){t(r)}))).then(n,i)}r((u=u.apply(o,s||[])).next())}))}function Ot(t,e){return n=this,i=void 0,o=function*(){const n=Array.isArray(e)?e:[e],i=[];for(let e of n)("string"!=typeof(r=e)._id||"string"!=typeof r._type||"string"!=typeof r.slug)&&(e=yield wt(t,e)),i.push(yield t.createOrReplace(e));var r;return{success:!0,status:1,source:f[f.sanity],data:i}},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function At(t,e){return n=this,i=void 0,o=function*(){const n=Array.isArray(e)?e:[e],i=[];for(const e of n){const n=yield t.assets.upload("image",e.stream),r={tagnumber:e.tagnumber,slug:e.slug};switch(e.type){case"found":r.foundImage=n._id;break;case"mystery":r.mysteryImage=n._id;break;default:r.foundImage=`${n._id},`}const o=yield wt(t,r);i.push(Object.assign(Object.assign({},n),{updated:o}))}return{success:!0,status:1,source:f[f.sanity],data:i}},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Pt(t,e=null,n){const i=`tag::${t}`,r=m(i);if(r)return r;const o=t.match(j);if(!o)return e||[];const s=o.reduce(((t,e)=>{let n=e.match(/\d+/);if(n=n&&n.length?n[0]:null,!n)return t;const i=Number.parseInt(n);return-1==t.indexOf(i)&&t.push(i),t}),[]);return!s.length&&e?(h(i,e,n),e):(h(i,s,n),s)}function Ut(t,e,n){const i=`credit::${t}`,r=m(i);if(r)return r;t.match(_);const o=_.exec(t);if(!o)return e||null;const s=o.filter((t=>"string"!=typeof t||-1!==t.indexOf("tag ")&&0===t.indexOf("tag")||-1!==t.indexOf("proof ")&&0===t.indexOf("proof")||-1!==t.indexOf("to:")||-1!==t.indexOf("hint:")||-1!==t.indexOf("by")&&0===t.indexOf("by")?void 0:t));if(!s.length&&e)return h(i,e,n),e;const a=s[0];return h(i,a,n),a}function Ct(t,e,n){if(!t||!t.length)return e;const i=`gps::${t}`,r=m(i);if(r)return r;t.match(L);const o=L.exec(t);if(!o)return h(i,e,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function Et(t,e,n){if(!t||!t.length)return e;const i=`gps::${t}`,r=m(i);if(r)return r;t.match(F);const o=F.exec(t);if(!o)return h(i,e,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function jt(t,e,n){const i=`hint::${t}`,r=m(i);if(r)return r;t.match(R);const o=R.exec(t);if(!o)return h(i,e=e||null,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function _t(t){return t.description?Pt(t.description)[0]:-1}function Ft(t,e,n){const i=(null==n?void 0:n.game)||"",r=Pt(t.description)[0],o=v(r,i);return{tagnumber:r,name:o,slug:o,game:i,discussionUrl:Ct(t.title),foundLocation:Et(null==e?void 0:e.description),player:Ut(t.description),hint:jt(t.description),mysteryImageUrl:t.link,foundImageUrl:null==e?void 0:e.link,gps:{lat:0,long:0,alt:0}}}const Rt=(t,e)=>at(t.link,e);function Dt(t,e){var n,i,r,o,s;return i=this,r=void 0,s=function*(){const i=[],r=[];if(e.tagnumber||e.slug){const t=yield this.getTag(null!==(n=e.tagnumber)&&void 0!==n?n:e.slug);t.foundImageUrl&&r.push(Rt({link:t.foundImageUrl})),t.mysteryImageUrl&&r.push(Rt({link:t.mysteryImageUrl}))}if(!r.length)throw new Error("Imgur delete hashes not set");for(const e of r)i.push(yield t.deleteImage(e));return{data:i,success:!0,source:f[f.imgur],status:200}},new((o=void 0)||(o=Promise))((function(t,e){function n(t){try{u(s.next(t))}catch(t){e(t)}}function a(t){try{u(s.throw(t))}catch(t){e(t)}}function u(e){var i;e.done?t(e.value):(i=e.value,i instanceof o?i:new o((function(t){t(i)}))).then(n,a)}u((s=s.apply(i,r||[])).next())}))}function St(t,e){var n,i,r,o,s,a,u,l;return s=this,a=void 0,l=function*(){if(!e.hash)throw new Error("no Imgur album hash set");const s=yield t.getAlbum(e.hash);let a=[];if(e.tagnumber)a=null===(i=null===(n=s.data)||void 0===n?void 0:n.images)||void 0===i?void 0:i.filter((t=>_t(t)==e.tagnumber));else if(!e.tagnumber&&"latest"===e.slug&&(null===(o=null===(r=s.data)||void 0===r?void 0:r.images)||void 0===o?void 0:o.length)>1){const t=function(t=[]){return t.sort(((t,e)=>{const n=_t(t),i=_t(e),r=n<0,o=Math.abs(i)-Math.abs(n);return 0!==o?o:r?-1:1}))}(s.data.images);a.push(t[0]),t[1]&&_t(t[0])===_t(t[1])&&a.push(t[1])}const u=[];a.forEach((t=>{const e=_t(t);u[e]=u[e]?u[e]:[],u[e].push(t)}));const l=[];return u.forEach((t=>{l.push(Ft(t[0],t[1],e))})),{data:l[0],success:!!l.length,source:f[f.imgur],status:200}},new((u=void 0)||(u=Promise))((function(t,e){function n(t){try{r(l.next(t))}catch(t){e(t)}}function i(t){try{r(l.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof u?r:new u((function(t){t(r)}))).then(n,i)}r((l=l.apply(s,a||[])).next())}))}var qt=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function Lt(t,e){var n,i,r,o,s;return qt(this,void 0,void 0,(function*(){const a=[];let u=[];const l=t=>{const e=[];return t.forEach((t=>{const n=_t(t);e[n]=e[n]?e[n]:[],e[n].push(t)})),e};if((null===(n=e.tagnumbers)||void 0===n?void 0:n.length)&&e.hash){const n=yield t.getAlbum(e.hash),o=null===(r=null===(i=n.data)||void 0===i?void 0:i.images)||void 0===r?void 0:r.filter((t=>-1!==e.tagnumbers.indexOf(_t(t))));u=l(o)}else if(null===(o=e.slugs)||void 0===o?void 0:o.length){const n=[],i=[];let r=!0;const o=t=>{(null==t?void 0:t.data)&&n.push(t.data),r=t.success&&r};e.slugs.forEach((e=>qt(this,void 0,void 0,(function*(){return i.push(t.getImage(e).then(o))})))),yield Promise.all(i).then((t=>{u=l(t)}))}else if(e.hash){const n=yield t.getAlbum(e.hash),i=(null===(s=null==n?void 0:n.data)||void 0===s?void 0:s.images)||[];u=l(i)}return u.forEach((t=>{const n=Ft(t[0],t[1],e);a.push(n)})),{data:a,success:!0,source:f[f.imgur],status:200}}))}var Mt=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function Nt(t){return"string"==typeof t.imageHash&&("string"==typeof t.title||"string"==typeof t.description)}function Bt(t,e=!0){return{imageHash:e?dt(t):ut(t),title:e?gt(t):ct(t),description:e?ft(t):lt(t)}}function Ht(t,e){return Mt(this,void 0,void 0,(function*(){const n=[],i=Array.isArray(e)?e:[e],r=e=>{const n=Bt(e),i=Bt(e,!1);return new Promise((r=>Mt(this,void 0,void 0,(function*(){var o,s,a,u;let l=!0;if(!Nt(n)||!Nt(i))throw new Error("one update payload is invalid");{const r=yield this.getTag(e.tagnumber);if(r.success&&(null===(s=null===(o=r.data)||void 0===o?void 0:o.mysteryImageUrl)||void 0===s?void 0:s.length))l=(yield t.updateImage(Object.assign(Object.assign({},n),{imageHash:at(r.data.mysteryImageUrl)}))).data;else{const t=yield this.uploadTagImage(Object.assign(Object.assign({},n),{mysteryImage:e.mysteryImageUrl,mysteryImageUrl:void 0}));(null==t?void 0:t.length)&&t[0].success?e.mysteryImageUrl=t[0].data.mysteryImageUrl:l=!1}if(r.success&&(null===(u=null===(a=r.data)||void 0===a?void 0:a.foundImageUrl)||void 0===u?void 0:u.length)){const e=yield t.updateImage(Object.assign(Object.assign({},i),{imageHash:at(r.data.foundImageUrl)}));l=l&&e.data}else{const t=yield this.uploadTagImage(Object.assign(Object.assign({},i),{foundImage:e.foundImageUrl,foundImageUrl:void 0}));(null==t?void 0:t.length)&&t[0].success?e.foundImageUrl=t[0].data.foundImageUrl:l=!1}}r({data:H(e),success:l,source:f[f.imgur],status:200})}))))};return i.map((t=>n.push(r(t)))),Promise.all(n).then((t=>t)).catch((t=>({data:t.message,success:!1,source:f[f.imgur],status:200})))}))}var Kt=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function Wt(t,e=!0){var n,i,r,o;return{album:null!==(n=t.album)&&void 0!==n?n:t.hash,type:null!==(i=t.type)&&void 0!==i?i:"url",image:e?t.mysteryImage:t.foundImage,title:null!==(r=t.title)&&void 0!==r?r:e?gt(t):ct(t),description:null!==(o=t.description)&&void 0!==o?o:e?ft(t):lt(t)}}function Gt(t){return t&&void 0!==t.image&&("string"==typeof t.title||"string"==typeof t.description)}function Vt(t,e){return Kt(this,void 0,void 0,(function*(){const n=[],i=Array.isArray(e)?e:[e],r=e=>{let n=!0;const i=!e.mysteryImageUrl&&e.mysteryImage?Wt(e):null,r=!e.foundImageUrl&&e.foundImage?Wt(e,!1):null;return new Promise((o=>Kt(this,void 0,void 0,(function*(){var s,a;if(Gt(i)){const r=yield t.upload(i);e.mysteryImageUrl=null===(s=r.data)||void 0===s?void 0:s.link,n=n&&r.success}if(Gt(r)){const i=yield t.upload(r);e.foundImageUrl=null===(a=i.data)||void 0===a?void 0:a.link,n=n&&i.success}o({data:H(e),success:n,source:f[f.imgur],status:200})}))))};return i.map((t=>n.push(r(t)))),Promise.all(n).then((t=>t)).catch((t=>({data:t.message,success:!1,source:f[f.imgur],status:200})))}))}function zt(t,e){return n=this,i=void 0,o=function*(){const n=`2/image/${e}`;return(yield t.request({url:n,method:"DELETE"})).data},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Jt(t,e){return n=this,i=void 0,o=function*(){const n=`2/image/${e}`;return(yield t.request({url:n})).data},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Qt(t,e){return n=this,i=void 0,o=function*(){if("string"!=typeof(n=e).title&&"string"!=typeof n.description)throw new Error("Update requires a title and/or description");var n;const i=`2/image/${e.slug}`;return(yield t.request({url:i,method:"DELETE"})).data},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Xt(t,e){return n=this,i=void 0,o=function*(){const n=`2/image/${e.slug}`;return(yield t.request({url:n,method:"DELETE"})).data},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Yt(t,e){return n=this,i=void 0,o=function*(){if(Array.isArray(e)){const t=e.map((t=>t));return yield Promise.all(t)}return t},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function Zt(t,e){return n=this,i=void 0,o=function*(){const n=`2/image/${e}/favorite`;return(yield t.request({url:n,method:"POST"})).data},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function te(t){return e=this,n=void 0,r=function*(){return{client:t}},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{u(r.next(t))}catch(t){o(t)}}function a(t){try{u(r.throw(t))}catch(t){o(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(s,a)}u((r=r.apply(e,n||[])).next())}));var e,n,i,r}var ee=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function ne(t,e){var n,i,r;return ee(this,void 0,void 0,(function*(){let o,s="",a=!0,u=!1;const l=[],c=[];for(const d of t)try{const t="imgur.com",g=`${t}/gallery/`,f=`${t}/a/`,h=d.is_gallery;if(d.selftext&&d.selftext.length)o=s=d.selftext;else if(d.media&&d.media.oembed)o=`${d.media.oembed.title} ${d.media.oembed.description}`,s=d.media.oembed.provider_url,a=!1;else if(((null===(n=d.preview)||void 0===n?void 0:n.images)||h)&&d.url){let t;yield d.expandReplies({depth:1}).then((e=>{t=e}));const e=(null===(i=t.comments)||void 0===i?void 0:i.length)?t.comments.filter((t=>t.author.name===d.author.name)):[];s=o=e.length?e.reduce(((t,e)=>`${t} ${e.body}`),d.url):d.url,u=!0}else s=null;if(s){const t=ot(s,[]),n=Z(o);let i=nt(o,""),m=et(o,""),v=it(o,void 0),p=tt(o,`u/${d.author.name}`),y=d.created_utc;const b=[];let w=n;for(let n=0;n<t.length;n++)try{const s=t[n],a=s.indexOf(g),u=s.indexOf(f),l=-1!==a,c=-1!==u,x=l?a:u,I=l?g.length:f.length;if(l||c){const t=rt(s,s.substring(x+I)),a=yield e.getAlbum(t);if(a)for(const t of a.data.images){const e=`${t.title} ${t.description}`,s=Z(e,[]);s.length&&(w.splice(n,1),w=w.concat(s)),b.push(t.link),y=null!==(r=t.datetime)&&void 0!==r?r:y,i=null!=i?i:nt(e,""),m=null!=m?m:et(o,""),p=null!=p?p:tt(o,""),v=null!=v?v:it(o,void 0),p=null!=p?p:t.account_url}}else if(h)for(const t of d.gallery_data.items)b.push(`https://preview.redd.it/${t.media_id}.jpg`);else b.push(s)}catch(t){console.error("get image url",t)}if(w.length){if(!m){m=o;const e=t=>{m=m.replace(t,"")},r=/\s*at\s*/gi;t.forEach(e),n.forEach((t=>e(`#${t}`))),p&&e(`(@|#|u/)?${p}`),v&&e(new RegExp(`(@|#)?${v.lat}.?${v.long}|(@|#)?${v.lat},${v.long}`,"gi")),i&&e(new RegExp(/(\()?(hint:?)?\s*(${hint})(\s?\))?/gi)),e(/\[(?:bike)?\s*tag\s*\d*\]\(\s*\)/gi),e(/\[\s*\]\(http.*\)/gi),e(/\[(?!(?:bike)?\s*tag\s*).*\]\(.*\)/gi),e(/\[(?:bike)?\s*tag\s*\d*\s*-/gi),e(/\]\(\s*\)/gi),e(/\r?\n?/gi),e(/\\/gi),e(/\(\s*\)/gi),e(/&#.*;/gi),(m.endsWith("at")||m.endsWith("at "))&&e(r),(m.startsWith("-")||m.startsWith(" -"))&&e(/^\s*-/i),(m.startsWith(",")||m.startsWith(" ,"))&&e(/^\s*,/i),m=m.trim()}l.push({id:d.id,isSelfPost:a,isImagePost:u,selftext:s,postBody:o,timestamp:y,tagNumbers:w,tagImageURLs:b,credit:p,gps:v,foundAt:m,hint:i,author_flair:d.author_flair_text})}else c.push(d)}}catch(t){console.error("assign",t)}return c.length&&console.log({unreadableRedditPosts:c}),l}))}function ie(t){return ee(this,void 0,void 0,(function*(){t.tagNumbers||(t.tagNumbers=[t.tagNumber]);const e=Math.max(...t.tagNumbers),n=e-1>1?e-1:1,i=t.tagNumbers.indexOf(e),r=t.tagImageURLs[i],o=t.tagNumbers.indexOf(n),s=-1!==o?t.tagImageURLs[o]:null,a=t.gps,u={foundLocation:t.foundAt,player:t.credit,hint:t.hint,gps:a,discussionUrl:`https://redd.it/${t.id}`,tagnumber:e,mysteryImageUrl:r,foundImageUrl:s};return H(u)}))}var re=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function oe(t,e){var n,i;return re(this,void 0,void 0,(function*(){if(!e)throw new Error("no options");if(!e.subreddit)throw new Error("no subreddit set");const r=`subreddit:${e.subreddit} title:Bike Tag`;return e.sort=null!==(n=e.sort)&&void 0!==n?n:"new",e.limit=1,e.time=null!==(i=e.time)&&void 0!==i?i:"all",t.getSubreddit(e.subreddit).search(Object.assign({query:r},e)).then((t=>re(this,void 0,void 0,(function*(){const e=yield ne(t,this.images);return{data:yield ie(e[0]),status:1,success:!0,source:f[f.reddit]}}))))}))}var se=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function ae(t,e){var n,i,r;return se(this,void 0,void 0,(function*(){if(!e)throw new Error("no options");const o=`subreddit:${e.subreddit} title:Bike Tag`;return e.sort=null!==(n=e.sort)&&void 0!==n?n:"new",e.limit=null!==(i=e.limit)&&void 0!==i?i:10,e.time=null!==(r=e.time)&&void 0!==r?r:"all",t.getSubreddit(e.subreddit).search(Object.assign({query:o},e)).then((t=>se(this,void 0,void 0,(function*(){const e=yield ne(t,this.images),n=[];for(const t of e)n.push(yield ie(t));return{data:n,status:1,success:!0,source:f[f.reddit]}}))))}))}function ue(t){return e=this,n=void 0,r=function*(){return{client:t}},new((i=void 0)||(i=Promise))((function(t,o){function s(t){try{u(r.next(t))}catch(t){o(t)}}function a(t){try{u(r.throw(t))}catch(t){o(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(s,a)}u((r=r.apply(e,n||[])).next())}));var e,n,i,r}function le(t,e){return n=this,i=void 0,o=function*(){if(Array.isArray(e)){const t=e.map((t=>t));return yield Promise.all(t)}return yield{client:t,req:null}},new((r=void 0)||(r=Promise))((function(t,e){function s(t){try{u(o.next(t))}catch(t){e(t)}}function a(t){try{u(o.throw(t))}catch(t){e(t)}}function u(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(s,a)}u((o=o.apply(n,i||[])).next())}));var n,i,r,o}function ce(t,e=null,n){const i=`tag::${t}`,r=m(i);if(r)return r;const o=t.match(j);if(!o)return e||[];const s=o.reduce(((t,e)=>{let n=e.match(/\d+/);if(n=n&&n.length?n[0]:null,!n)return t;const i=Number.parseInt(n);return-1==t.indexOf(i)&&t.push(i),t}),[]);return!s.length&&e?(h(i,e,n),e):(h(i,s,n),s)}function de(t,e,n){const i=`credit::${t}`,r=m(i);if(r)return r;t.match(_);const o=_.exec(t);if(!o)return e||null;const s=o.filter((t=>"string"!=typeof t||-1!==t.indexOf("tag ")&&0===t.indexOf("tag")||-1!==t.indexOf("proof ")&&0===t.indexOf("proof")||-1!==t.indexOf("to:")||-1!==t.indexOf("hint:")||-1!==t.indexOf("by")&&0===t.indexOf("by")?void 0:t));if(!s.length&&e)return h(i,e,n),e;const a=s[0];return h(i,a,n),a}function ge(t,e,n){if(!t||!t.length)return e;const i=`gps::${t}`,r=m(i);if(r)return r;t.match(L);const o=L.exec(t);if(!o)return h(i,e,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function fe(t,e,n){if(!t||!t.length)return e;const i=`gps::${t}`,r=m(i);if(r)return r;t.match(F);const o=F.exec(t);if(!o)return h(i,e,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function he(t,e,n){const i=`hint::${t}`,r=m(i);if(r)return r;t.match(R);const o=R.exec(t);if(!o)return h(i,e=e||null,n),e;const s=(o[1]||"").trim();return h(i,s,n),s}function me(t){return t.description?ce(t.description)[0]:-1}function ve(t,e,n){var i;const r=null!==(i=null==n?void 0:n.game)&&void 0!==i?i:"",o=ce(t.description)[0],s=v(o,r);return{tagnumber:o,name:s,slug:s,game:r,discussionUrl:ge(t.title),foundLocation:fe(null==e?void 0:e.description),player:de(t.description),hint:he(t.description),mysteryImageUrl:t.link,foundImageUrl:null==e?void 0:e.link,gps:{lat:0,long:0,alt:0}}}const pe=(t,e)=>at(t.link,e);function ye(t,e){var n,i,r,o,s;return i=this,r=void 0,s=function*(){const i=[],r=[];if(e.tagnumber||e.slug){const t=yield this.getTag(null!==(n=e.tagnumber)&&void 0!==n?n:e.slug);t.foundImageUrl&&r.push(pe({link:t.foundImageUrl})),t.mysteryImageUrl&&r.push(pe({link:t.mysteryImageUrl}))}if(!r.length)throw new Error("Imgur delete hashes not set");for(const e of r)i.push(yield t.deleteImage(e));return{data:i,success:!0,source:f[f.imgur],status:200}},new((o=void 0)||(o=Promise))((function(t,e){function n(t){try{u(s.next(t))}catch(t){e(t)}}function a(t){try{u(s.throw(t))}catch(t){e(t)}}function u(e){var i;e.done?t(e.value):(i=e.value,i instanceof o?i:new o((function(t){t(i)}))).then(n,a)}u((s=s.apply(i,r||[])).next())}))}function be(t,e){var n,i,r,o,s,a,u,l;return s=this,a=void 0,l=function*(){if(!e.hash)throw new Error("no Imgur album hash set");const s=yield t.getAlbum(e.hash);let a=[];if(e.tagnumber)a=null===(i=null===(n=s.data)||void 0===n?void 0:n.images)||void 0===i?void 0:i.filter((t=>me(t)==e.tagnumber));else if(!e.tagnumber&&"latest"===e.slug&&(null===(o=null===(r=s.data)||void 0===r?void 0:r.images)||void 0===o?void 0:o.length)>1){const t=function(t=[]){return t.sort(((t,e)=>{const n=me(t),i=me(e),r=n<0,o=Math.abs(i)-Math.abs(n);return 0!==o?o:r?-1:1}))}(s.data.images);a.push(t[0]),t[1]&&me(t[0])===me(t[1])&&a.push(t[1])}const u=[];a.forEach((t=>{const e=me(t);u[e]=u[e]?u[e]:[],u[e].push(t)}));const l=[];return u.forEach((t=>{l.push(ve(t[0],t[1],e))})),{data:l[0],success:!!l.length,source:f[f.imgur],status:200}},new((u=void 0)||(u=Promise))((function(t,e){function n(t){try{r(l.next(t))}catch(t){e(t)}}function i(t){try{r(l.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof u?r:new u((function(t){t(r)}))).then(n,i)}r((l=l.apply(s,a||[])).next())}))}var we=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function xe(t,e){var n,i,r,o,s;return we(this,void 0,void 0,(function*(){const a=[];let u=[];const l=t=>{const e=[];return t.forEach((t=>{const n=me(t);e[n]=e[n]?e[n]:[],e[n].push(t)})),e};if((null===(n=e.tagnumbers)||void 0===n?void 0:n.length)&&e.hash){const n=yield t.getAlbum(e.hash),o=null===(r=null===(i=n.data)||void 0===i?void 0:i.images)||void 0===r?void 0:r.filter((t=>-1!==e.tagnumbers.indexOf(me(t))));u=l(o)}else if(null===(o=e.slugs)||void 0===o?void 0:o.length){const n=[],i=[];let r=!0;const o=t=>{(null==t?void 0:t.data)&&n.push(t.data),r=t.success&&r};e.slugs.forEach((e=>we(this,void 0,void 0,(function*(){return i.push(t.getImage(e).then(o))})))),yield Promise.all(i).then((t=>{u=l(t)}))}else if(e.hash){const n=yield t.getAlbum(e.hash),i=(null===(s=null==n?void 0:n.data)||void 0===s?void 0:s.images)||[];u=l(i)}return u.forEach((t=>{const n=ve(t[0],t[1],e);a.push(n)})),{data:a,success:!0,source:f[f.imgur],status:200}}))}var Ie=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function Te(t){return"string"==typeof t.imageHash&&("string"==typeof t.title||"string"==typeof t.description)}function $e(t,e=!0){return{imageHash:e?dt(t):ut(t),title:e?gt(t):ct(t),description:e?ft(t):lt(t)}}function ke(t,e){return Ie(this,void 0,void 0,(function*(){const n=[],i=Array.isArray(e)?e:[e],r=e=>{const n=$e(e),i=$e(e,!1);return new Promise((r=>Ie(this,void 0,void 0,(function*(){var o,s,a,u;let l=!0;if(!Te(n)||!Te(i))throw new Error("one update payload is invalid");{const r=yield this.getTag(e.tagnumber);if(r.success&&(null===(s=null===(o=r.data)||void 0===o?void 0:o.mysteryImageUrl)||void 0===s?void 0:s.length))l=(yield t.updateImage(Object.assign(Object.assign({},n),{imageHash:at(r.data.mysteryImageUrl)}))).data;else{const t=yield this.uploadTagImage(Object.assign(Object.assign({},n),{mysteryImage:e.mysteryImageUrl,mysteryImageUrl:void 0}));(null==t?void 0:t.length)&&t[0].success?e.mysteryImageUrl=t[0].data.mysteryImageUrl:l=!1}if(r.success&&(null===(u=null===(a=r.data)||void 0===a?void 0:a.foundImageUrl)||void 0===u?void 0:u.length)){const e=yield t.updateImage(Object.assign(Object.assign({},i),{imageHash:at(r.data.foundImageUrl)}));l=l&&e.data}else{const t=yield this.uploadTagImage(Object.assign(Object.assign({},i),{foundImage:e.foundImageUrl,foundImageUrl:void 0}));(null==t?void 0:t.length)&&t[0].success?e.foundImageUrl=t[0].data.foundImageUrl:l=!1}}r({data:H(e),success:l,source:f[f.imgur],status:200})}))))};return i.map((t=>n.push(r(t)))),Promise.all(n).then((t=>t)).catch((t=>({data:t.message,success:!1,source:f[f.imgur],status:200})))}))}var Oe=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))};function Ae(t,e=!0){var n,i,r,o;return{album:null!==(n=t.album)&&void 0!==n?n:t.hash,type:null!==(i=t.type)&&void 0!==i?i:"url",image:e?t.mysteryImage:t.foundImage,title:null!==(r=t.title)&&void 0!==r?r:e?gt(t):ct(t),description:null!==(o=t.description)&&void 0!==o?o:e?ft(t):lt(t)}}function Pe(t){return t&&void 0!==t.image&&("string"==typeof t.title||"string"==typeof t.description)}function Ue(t,e){return Oe(this,void 0,void 0,(function*(){const n=[],i=Array.isArray(e)?e:[e],r=e=>{let n=!0;const i=!e.mysteryImageUrl&&e.mysteryImage?Ae(e):null,r=!e.foundImageUrl&&e.foundImage?Ae(e,!1):null;return new Promise((o=>Oe(this,void 0,void 0,(function*(){var s,a;if(Pe(i)){const r=yield t.upload(i);e.mysteryImageUrl=null===(s=r.data)||void 0===s?void 0:s.link,n=n&&r.success}if(Pe(r)){const i=yield t.upload(r);e.foundImageUrl=null===(a=i.data)||void 0===a?void 0:a.link,n=n&&i.success}o({data:H(e),success:n,source:f[f.imgur],status:200})}))))};return i.map((t=>n.push(r(t)))),Promise.all(n).then((t=>t)).catch((t=>({data:t.message,success:!1,source:f[f.imgur],status:200})))}))}const Ce=require("snoowrap");var Ee=t.n(Ce);const je=require("imgur");var _e=t.n(je);const Fe=require("@sanity/client");var Re=t.n(Fe);const De="biketag-api (https://github.com/keneucker/biketag-api)";class Se extends d.EventEmitter{constructor(t){super(),this.config=t,this.expressions=n,this.getters=i,this.mostAvailableApi=void 0;const e=this.setConfiguration(null!=t?t:{});this.initializeClients(e),this.plainFetcher=c().create({headers:{"user-agent":De},responseType:"json"}),this.fetcher=c().create({baseURL:g,headers:{"user-agent":De},responseType:"json"}),this.cachedFetcher=(0,U.setup)({baseURL:g,cache:{maxAge:9e5,exclude:{methods:["put","patch","delete"]}},headers:{"user-agent":De},responseType:"json"})}getDefaultOptions(t,e="tag",n){var i,r,o,s,a,u,l;const c="string"==typeof t?{slug:t}:"number"==typeof t&&"tag"===e?{tagnumber:t}:Array.isArray(t)&&"tag"===e?{tagnumbers:t}:Array.isArray(t)?{payload:t}:null!=t?t:{};switch(c.source="string"==typeof n?f[n]:void 0===n?this.getMostAvailableAPI():n,e){case"game":c.game=null!==(i=c.game)&&void 0!==i?i:c.slug,c.slug=null!==(s=null!==(r=c.slug)&&void 0!==r?r:null===(o=c.game)||void 0===o?void 0:o.toLowerCase())&&void 0!==s?s:void 0;break;case"tag":c.game=c.game?c.game:this.biketagConfig.game,(null===(a=this.imgurConfig)||void 0===a?void 0:a.hash)&&(c.hash=null!==(u=c.hash)&&void 0!==u?u:this.imgurConfig.hash),c.slug||(c.tagnumber&&void 0!==c.tagnumber?c.slug=v(c.tagnumber,c.game):c.slug="latest"),c.tagnumber||"latest"!==c.slug&&(c.tagnumber=Y(c.slug))}return c.source===f.reddit&&(c.subreddit=null!==(l=c.subreddit)&&void 0!==l?l:this.redditConfig.subreddit),c}getDefaultAPI(t={},e={},n){var i;const l=null!==(i=e.source)&&void 0!==i?i:this.getMostAvailableAPI();delete e.source;const c=Object.assign(Object.assign({},this.getDefaultOptions(t,n,l)),e);let d=null,g=null;switch(c.source){case f.sanity:d=this.sanityClient,g=r;break;case f.imgur:d=this.imgurClient,g=o;break;case f.reddit:d=this.redditClient,g=a;break;case f.twitter:d=this.twitterClient,g=u;break;default:case f.biketag:d=g=s}return{client:d,api:g,options:c}}getMostAvailableAPI(){return this.mostAvailableApi?this.mostAvailableApi:this.biketagConfig&&w(this.biketagConfig)&&void 0!==(t=this.biketagConfig).clientToken&&void 0!==t.clientKey?this.mostAvailableApi=f.biketag:this.imgurConfig&&this.imgurClient?this.mostAvailableApi=f.imgur:this.sanityConfig&&this.sanityClient?this.mostAvailableApi=f.sanity:this.redditConfig&&this.redditClient?this.mostAvailableApi=f.reddit:this.twitterConfig&&this.twitterClient?this.mostAvailableApi=f.twitter:void 0;var t}getPassthroughApiMethod(t,e){return n=>t(e,this.getDefaultOptions(n))}initializeClients(t){var e;return(t=null!=t?t:this.getConfiguration()).imgur&&p(this.imgurConfig)&&void 0!==(null==(e=this.imgurConfig)?void 0:e.clientId)&&(this.imgurClient=new(_e())(t.imgur)),t.sanity&&b(this.sanityConfig)&&(t=>void 0!==t.projectId&&void 0!==t.dataset&&void 0!==t.token&&void 0!==t.apiVersion)(this.sanityConfig)&&(this.sanityClient=Re()(t.sanity)),t.reddit&&y(this.redditConfig)&&(t=>void 0!==(null==t?void 0:t.userAgent)&&void 0!==(null==t?void 0:t.clientId)&&(void 0!==(null==t?void 0:t.clientSecret)&&void 0!==(null==t?void 0:t.refreshToken)||void 0!==(null==t?void 0:t.username)&&void 0!==(null==t?void 0:t.password)))(this.redditConfig)&&(this.redditClient=new(Ee())(t.reddit)),t.twitter&&(t=>void 0!==(null==t?void 0:t.clientId)||void 0!==(null==t?void 0:t.clientSecret)||void 0!==(null==t?void 0:t.clientId)&&void 0!==(null==t?void 0:t.account))(this.twitterConfig)&&(t=>{void 0!==t.clientToken&&t.clientKey})(this.twitterConfig),t}setConfiguration(t,e=!0,n=!1){const i=(t=>{const e={},n={biketag:(i=t,w(i)?P(i):void 0),sanity:k(t),imgur:T(t),reddit:A(t)};var i;return e.biketag=t.biketag?Object.assign(Object.assign({},n.biketag),P(t.biketag)):n.biketag,e.sanity=t.sanity?Object.assign(Object.assign({},n.sanity),$(t.sanity)):n.sanity,e.imgur=t.imgur?Object.assign(Object.assign({},n.imgur),I(t.imgur)):n.imgur,e.reddit=t.reddit?Object.assign(Object.assign({},n.reddit),O(t.reddit)):n.reddit,e})(t),r=(t,e,n=!0)=>{const i=`${f[t]}Config`,r=e[f[t]];let o=P;switch(t){case f.imgur:o=I;break;case f.reddit:o=O;break;case f.sanity:o=$;break;case f.twitter:o=x}return!n&&this[i]&&r?o(r,this[i]):null!=r?r:this[i]},o=r(f.biketag,i,e),s=r(f.imgur,i,e),a=r(f.sanity,i,e),u=r(f.reddit,i,e),l=r(f.twitter,i,e);if(n){const t={biketag:void 0,imgur:void 0,reddit:void 0,sanity:void 0,twitter:void 0};E().isEqual(this.imgurConfig,s)||(t.imgur=s),E().isEqual(this.redditConfig,u)||(t.reddit=u),E().isEqual(this.sanityConfig,a)||(t.sanity=a),E().isEqual(this.twitterConfig,l)||(t.twitter=l),this.initializeClients(t)}return this.biketagConfig=o,this.imgurConfig=s,this.sanityConfig=a,this.redditConfig=u,this.twitterConfig=l,this.getConfiguration()}getConfiguration(t){var e,n,i,r,o;return{biketag:null!==(e=null==t?void 0:t.biketag)&&void 0!==e?e:this.biketagConfig,sanity:null!==(n=null==t?void 0:t.sanity)&&void 0!==n?n:this.sanityConfig,imgur:null!==(i=null==t?void 0:t.imgur)&&void 0!==i?i:this.imgurConfig,reddit:null!==(r=null==t?void 0:t.reddit)&&void 0!==r?r:this.redditConfig,twitter:null!==(o=null==t?void 0:t.twitter)&&void 0!==o?o:this.twitterConfig}}plainRequest(t={}){return this.plainFetcher(t)}cachedRequest(t={}){return this.cachedFetcher(t)}request(t={}){return this.fetcher(t)}getGameData(t){const e="string"==typeof t?{game:t}:t,{client:n,options:i,api:r}=this.getDefaultAPI(e,{source:f.sanity},"game");return r.getGameData(n,i).catch((t=>({status:500,data:null,error:t,success:!1,source:f[i.source]})))}importTag(t){return t}deleteTag(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);let o=r.deleteTag;return i.source===f.imgur&&(o={getTag:this.getPassthroughApiMethod(r.getTag,n)}),o(n,i).catch((t=>Promise.resolve({status:500,data:null,error:t,success:!1,source:f[i.source]})))}deleteTags(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);let o=r.deleteTags;return i.source===f.imgur&&(o=o.bind({getTags:this.getPassthroughApiMethod(r.getTags,n)})),o(n,i).catch((t=>Promise.resolve({status:500,data:null,error:t,success:!1,source:f[i.source]})))}getTag(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);let o=r.getTag;return i.source===f.reddit&&(o=o.bind({images:this.images(Object.assign(Object.assign({},this.imgurConfig),e))})),o(n,i).catch((t=>({status:500,data:null,error:t,success:!1,source:f[i.source]})))}getTags(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);let o=r.getTags;return i.source===f.reddit&&(o=o.bind({images:this.images(Object.assign(Object.assign({},this.imgurConfig),e))})),o(n,i).catch((t=>({status:500,data:null,error:t,success:!1,source:f[i.source]})))}updateTag(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);let o=r.updateTag;return i.source===f.imgur&&(o=o.bind({getTag:this.getPassthroughApiMethod(r.getTag,n),uploadTagImage:this.getPassthroughApiMethod(r.uploadTagImage,n)})),o(n,i).catch((t=>Promise.resolve({status:500,data:null,error:t,success:!1,source:f[i.source]})))}uploadTagImage(t,e){const{client:n,options:i,api:r}=this.getDefaultAPI(t,e);return r.uploadTagImage(n,i).catch((t=>Promise.resolve({status:500,data:null,error:t,success:!1,source:f[i.source]})))}content(t={}){if(b(t))return Re()(t);throw new Error("options are invalid for creating a sanity client")}images(t={}){if(p(t))return new(_e())(t);throw new Error("options are invalid for creating an imgur client")}discussions(t={}){if(y(t))return new(Ee())(t);throw new Error("options are invalid for creating an imgur client")}data(){return this}}const qe=Se;return e})()}));